{% extends "layout.html" %}
{% block title %}Language Map{% endblock %}
{% include "legend.html" %}
{% block head_js %}
<meta charset="utf-8">
<style type="text/css">
.labelBody {
  margin-top: 0;
  margin-bottom: 0;
  margin-right: 0;
}
</style>
{% endblock %}
{% block content %}
<div id="d3_container">
  <svg id="d3_svg_container">
    <g id="parent_grouper">
      <g id="art"></g>
      <g id="labels"></g>
    </g>
  </svg>
</div>

<p><div id="shown_list"></div></p>
<p><div id="not_shown_list"></div></p>

<form><button onclick='render([5, 15])'>Only Show Big Languages</button></form>
<script type="text/javascript"
  src="{{ url_for('static', filename='d3.v359.min.js') }}"></script>
<script type="text/javascript"
  src="{{ url_for('static', filename='topojson.min.js') }}"></script>
<script type="text/javascript">

var width = 960,
    height = 500,
    //speaker_count_display_threshold = 50,  // Negative for ambiguous points
    speaker_count_display_threshold = -3,  // Negative for ambiguous points
    circle_base_radius = 5;

function render(data) {
  var scale = (d3.event == null) ? 1 : d3.event.scale;

  d3.select("#art").selectAll("path")
    .data(topojson.feature(data, data.objects.austates).features)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("fill", "#fff")
    .attr("fill-opacity", 0)
    .attr("stroke", "#ddd")

  var locations_to_plot = locations.filter(function(x) {
    return x["speaker_count"] >= speaker_count_display_threshold && x["lat"] != null;
  });
  var locations_to_hide = locations.filter(function(x) {
    return x["speaker_count"] < speaker_count_display_threshold || x["lat"] == null;
  });

  // Legend
  d3.select("#shown_list").selectAll("p")
    .data([locations_to_plot.length])
    .enter()
    .append("p")
    .html(function(d) {return "Showing " + d + " languages on map:";});

  d3.select("#shown_list").selectAll("span")
    .data(locations_to_plot)
    .enter()
    .append("span")
    .html(function(d) {return '<a href="/' + d.url + '">' + d.name + '</a> '})
    .attr("class", function(d) { return d.css_class });

  d3.select("#not_shown_list").selectAll("p")
    .data([locations_to_hide.length])
    .enter()
    .append("p")
    .html(function(d) {return "Not showing " + d + " languages on map (below population threshold or no location data):";});

  d3.select("#not_shown_list").selectAll("span")
    .data(locations_to_hide)
    .enter()
    .append("span")
    .html(function(d) {return '<a href="/' + d.url + '">' + d.name + '</a> '})
    .attr("class", function(d) { return d.css_class });

  // Points
  d3.select("#art").selectAll('circle')
    .data(locations_to_plot)
    .enter()
    .append('circle')
    .attr('fill', 'steelblue');

  d3.selectAll('circle')
    .attr('cx', function(d) {return projection([d.lon, d.lat])[0]})
    .attr('cy', function(d) {return projection([d.lon, d.lat])[1]})
    .attr('r', circle_base_radius / scale)

  // Label SVG container
  d3.select("#labels").selectAll('foreignObject')
    .data(locations_to_plot)
    .enter()
    .append('foreignObject')
    // And an HTML label within the SVG container
    .append("xhtml:body")
    .classed('labelBody', true)
    .attr('id', function(d) { return d.name + '-labelBody' })
    // The URL in the href has a leading slash so that the path is transformed
    //  when the static site is made.
    .html(function(d) {return '<a class="' + d.css_class + '" href="/' + d.url + '">' + d.name + '</a>'})

  d3.selectAll('foreignObject')
    .attr('x', function(d) {return get_svg_label_x_coord(d, scale)})
    .attr('y', function(d) {return get_svg_label_y_coord(d, scale)})
    // html label = margin + width
    .attr('width', function(d) {return get_svg_label_width(d, scale) + "em"})
    .attr('height', function(d) {return get_svg_label_height(d, scale) + "em"})

  d3.selectAll('.labelBody')
    .style("margin-left", function(d) { return get_html_margin_size(d, scale) + "em"})
    .style('width', function(d) {return get_html_label_width(d, scale) + "em"})
    .style('height', function(d) {return get_html_label_height(d, scale) + "em"})
    // 1em is the size of the font, even after the font-size adjustments
    //  have been made
    .style("font-size", function(d) {return get_html_label_font_size(d, scale) + "em"})
}

function get_element_font_size(element) {
  px_str = getComputedStyle(document.getElementById(element)).fontSize
  // no need to remove the "px" as parseInt is smart enough to do it
  return parseInt(px_str)
}

function get_svg_label_x_coord(d, scale) {
  return projection([d.lon, d.lat])[0] + (circle_base_radius / scale) + 0;
}

function get_svg_label_y_coord(d, scale) {
  return projection([d.lon, d.lat])[1] - get_element_font_size(d.name + "-labelBody");
}

function get_svg_label_width(d, scale) {
  // let's say 1em width per character i.e. d.name.length * 1
  return d.name.length / scale;
}

function get_svg_label_height(d, scale) {
  // Safari and Firefox only paint foreignObjects inside the bounds of the
  //  enclosing SVG element, so we need to add a bit more padding.
  // Chrome paints the entire foreignObject, even when it exceeds the
  //  bounds of the SVG element
  extra_scaling_factor = 1.1;
  if (d.css_class.indexOf("speakers_many") >= 0) {
    initial_em_height = 1.5 * extra_scaling_factor;
  }
  else {
    initial_em_height = 1.0 * extra_scaling_factor;
  }
  return (initial_em_height / scale);
}

function get_html_label_font_size(d, scale) {
  initial_em_height = 1.0;  // em
  return initial_em_height / scale;
}

function get_html_label_height(d, scale) {
  if (d.css_class.indexOf("speakers_many") >= 0) {
    initial_em_height = 1.5;
  }
  else {
    initial_em_height = 1.0;
  }
  return initial_em_height;
}

function get_html_label_width(d, scale) {
  // let's say 1em width per character i.e. d.name.length * 1
  return d.name.length / scale;
}

function get_html_margin_size(d, scale) {
  initial_size = 0.5;  // em
  return initial_size / scale;
}

// url field lacks a leading slash - this is added when the href
// is constructed. See comments in that part of the code
var locations = [
{% for iso, lat, lon, speaker_count, css_class in map_data %}
{ name: "{{ iso }}", lat: {{ lat }}, lon: {{ lon }}, speaker_count: {{ speaker_count }}, css_class: "{{ css_class }}", url: "language/iso/{{ iso }}" },
{% endfor %}
];

var projection = d3.geo.mercator()
    .center([135, -26])
    .scale(600);

var path = d3.geo.path()
    .projection(projection);

// Set dimensions of SVG element
d3.select("#d3_svg_container")
    .attr("width", width)
    .attr("height", height);

d3.json("{{ url_for('static', filename='au-states-topo.json') }}", function(error, data) {
  var zoomListener = d3.behavior.zoom()
    .on("zoom", function zoomHandler() {
      render(data)
      d3.select("#parent_grouper")
        .attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    });

  zoomListener(d3.select("#parent_grouper"));

  if (error) {
    return console.error(error);
  }
  else {
    render(data);
  }
});
</script>
{% endblock %}
